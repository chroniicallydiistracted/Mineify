<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spotify Analytics Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#fff}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    header{text-align:center;padding:40px 0;position:relative}
    h1{font-size:3em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .subtitle{font-size:1.2em;opacity:.9}
    .auth-section{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:20px;padding:30px;margin:30px auto;max-width:500px;text-align:center}
    .btn{background:#1DB954;color:#fff;border:0;padding:15px 40px;font-size:1.1em;border-radius:50px;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;gap:10px;text-decoration:none;margin:10px}
    .btn:hover{background:#1ed760;transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .dashboard{display:none;animation:fadeIn .5s ease}
    .dashboard.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .time-selector{display:flex;justify-content:center;gap:10px;margin:30px 0;flex-wrap:wrap}
    .time-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.3);color:#fff;padding:10px 25px;border-radius:25px;cursor:pointer;transition:.3s}
    .time-btn.active{background:rgba(255,255,255,.3);border-color:#1DB954}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:30px 0}
    .stat-card{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:20px;padding:25px;transition:.3s}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-card h3{margin-bottom:20px;font-size:1.3em;display:flex;align-items:center;gap:10px}
    .stat-value{font-size:2.5em;font-weight:bold;margin:10px 0}
    .stat-label{opacity:.8;font-size:.9em}
    .top-items{list-style:none;padding:0}
    .top-item{display:flex;align-items:center;gap:15px;padding:10px;margin:10px 0;background:rgba(255,255,255,.05);border-radius:10px;transition:.3s}
    .top-item:hover{background:rgba(255,255,255,.1)}
    .item-rank{font-size:1.5em;font-weight:bold;width:30px;text-align:center;color:#1DB954}
    .item-image{width:50px;height:50px;border-radius:5px;object-fit:cover}
    .item-info{flex:1}
    .item-name{font-weight:600;margin-bottom:3px}
    .item-artist{font-size:.9em;opacity:.8}
    .loading{text-align:center;padding:50px}
    .spinner{border:4px solid rgba(255,255,255,.3);border-radius:50%;border-top:4px solid #1DB954;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .user-profile{display:flex;align-items:center;gap:15px;background:rgba(255,255,255,.1);padding:15px;border-radius:15px;margin-bottom:30px}
    .user-avatar{width:60px;height:60px;border-radius:50%;object-fit:cover}
    .genre-cloud{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:20px}
    .genre-tag{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;font-size:.9em;transition:.3s}
    .genre-tag:hover{background:rgba(255,255,255,.3);transform:scale(1.05)}
    .audio-features{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;padding:20px}
    .feature-item{text-align:center}
    .feature-bar{width:100%;height:8px;background:rgba(255,255,255,.2);border-radius:4px;overflow:hidden;margin:10px 0}
    .feature-fill{height:100%;background:#1DB954;border-radius:4px;transition:width .5s ease}
    .recommendations{background:rgba(255,255,255,.05);border-radius:20px;padding:20px;margin:20px 0}
    .rec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:20px}
    .rec-item{text-align:center;cursor:pointer;transition:.3s}
    .rec-item:hover{transform:scale(1.05)}
    .rec-image{width:100%;aspect-ratio:1;border-radius:10px;object-fit:cover;margin-bottom:10px}
    .rec-name{font-size:.9em;font-weight:600}
    .rec-artist{font-size:.8em;opacity:.8}
    @media (max-width:768px){h1{font-size:2em}.stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸŽµ Spotify Analytics Dashboard</h1>
      <p class="subtitle">Your personal music insights & statistics</p>
    </header>

    <div id="authSection" class="auth-section">
      <h2>Connect Your Spotify Account</h2>
      <p style="margin:20px 0;opacity:.9;">Authorize this app to access your Spotify data.</p>
      <button id="loginBtn" class="btn" type="button">Connect with Spotify</button>
      <div style="margin-top:30px;padding:20px;background:rgba(0,0,0,.2);border-radius:10px;">
        <h3 style="margin-bottom:15px;">Setup Instructions:</h3>
        <ol style="text-align:left;line-height:1.8;">
          <li>Go to <a href="https://developer.spotify.com/dashboard" target="_blank" style="color:#1DB954;">Spotify Developer Dashboard</a></li>
          <li>Create/select an app</li>
          <li>Add <code id="currentRedirectUri">https://spotify.westfam.media/callback</code> to Redirect URIs</li>
          <li>Paste your Client ID below</li>
        </ol>
        <input id="clientId" type="text" placeholder="Enter your Spotify Client ID"
               style="width:100%;padding:10px;margin-top:15px;border-radius:5px;border:none;background:rgba(255,255,255,.9);color:#333;">
      </div>
    </div>

    <div id="dashboard" class="dashboard">
      <div id="userProfile" class="user-profile" style="display:none;"></div>

      <div class="time-selector">
        <button class="time-btn" data-range="short_term">Last 4 Weeks</button>
        <button class="time-btn active" data-range="medium_term">Last 6 Months</button>
        <button class="time-btn" data-range="long_term">All Time</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><h3>ðŸ“Š Top Tracks</h3><div id="topTracks" class="loading"><div class="spinner"></div></div></div>
        <div class="stat-card"><h3>ðŸŽ¤ Top Artists</h3><div id="topArtists" class="loading"><div class="spinner"></div></div></div>
        <div class="stat-card"><h3>ðŸŽ¸ Top Genres</h3><div id="topGenres" class="loading"><div class="spinner"></div></div></div>
        <div class="stat-card"><h3>ðŸŽµ Audio Features</h3><div id="audioFeatures" class="loading"><div class="spinner"></div></div></div>
        <div class="stat-card"><h3>ðŸ“ˆ Listening Stats</h3><div id="listeningStats" class="loading"><div class="spinner"></div></div></div>
        <div class="stat-card"><h3>ðŸ•’ Recently Played</h3><div id="recentlyPlayed" class="loading"><div class="spinner"></div></div></div>
      </div>

      <div class="recommendations">
        <h3>ðŸŽ¯ Recommended For You</h3>
        <p style="opacity:.8;margin-bottom:20px;">Based on your listening history</p>
        <div id="recommendations" class="rec-grid loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <script>
    // ----- Auth constants
    const SPOTIFY_AUTH_ENDPOINT = 'https://accounts.spotify.com/authorize';
    const TOKEN_ENDPOINT = 'https://accounts.spotify.com/api/token';
    const REDIRECT_URI = window.location.origin + '/callback';
    const SCOPES = [
      'user-top-read','user-read-recently-played','user-read-private',
      'user-read-email','playlist-read-private','user-library-read','user-follow-read'
    ].join(' ');

    let accessToken = null;
    let refreshToken = null;
    let tokenExpiresAt = 0;
    let currentTimeRange = 'medium_term';

    // ----- PKCE helpers (per Spotify docs)
    // generate verifier
    function generateRandomString(len){
      const possible='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const values=crypto.getRandomValues(new Uint8Array(len));
      return [...values].map(v=>possible[v%possible.length]).join('');
    }
    async function sha256(plain){ return await crypto.subtle.digest('SHA-256', new TextEncoder().encode(plain)); }
    function base64url(input){
      return btoa(String.fromCharCode(...new Uint8Array(input)))
        .replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    }
    async function pkceChallengeFromVerifier(v){ return base64url(await sha256(v)); }

    // ----- Token storage
    function loadStoredToken(){
      accessToken = localStorage.getItem('access_token') || null;
      refreshToken = localStorage.getItem('refresh_token') || null;
      tokenExpiresAt = parseInt(localStorage.getItem('expires_at') || '0', 10);
      return accessToken && Date.now() < tokenExpiresAt - 5000;
    }
    function storeToken(response){
      accessToken = response.access_token;
      refreshToken = response.refresh_token || refreshToken; // PKCE refresh token rotates
      tokenExpiresAt = Date.now() + (response.expires_in * 1000);
      localStorage.setItem('access_token', accessToken);
      if (refreshToken) localStorage.setItem('refresh_token', refreshToken);
      localStorage.setItem('expires_at', String(tokenExpiresAt));
    }
    async function ensureValidToken(clientId){
      if (accessToken && Date.now() < tokenExpiresAt - 5000) return true;
      if (!refreshToken) return false;
      // Refresh (PKCE requires client_id here)
      const body = new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: refreshToken,
        client_id: clientId
      });
      const res = await fetch(TOKEN_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      if (!res.ok) return false;
      const json = await res.json();
      storeToken(json);
      return true;
    }

    // ----- UI helpers
    function showDashboard(){
      document.getElementById('authSection').style.display='none';
      document.getElementById('dashboard').classList.add('active');
    }

    // ----- Fetch wrapper
    async function fetchSpotifyData(endpoint, clientId){
      // keep token fresh
      const ok = await ensureValidToken(clientId);
      if (!ok) return null;

      try{
        const res = await fetch(`https://api.spotify.com/v1/${endpoint}`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }catch(err){
        console.error('Spotify fetch error:', err);
        return null;
      }
    }

    // ----- App boot
    document.addEventListener('DOMContentLoaded', async () => {
      const el = document.getElementById('currentRedirectUri');
      if (el) el.textContent = REDIRECT_URI;

      // If we already have a valid token â†’ go straight in
      if (loadStoredToken()){
        showDashboard();
        loadAllData();
        attachHandlers();
        return;
      }

      // Handle PKCE callback (?code=...)
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (code){
        const clientId = localStorage.getItem('client_id_for_pkce');
        const codeVerifier = localStorage.getItem('code_verifier');
        if (!clientId || !codeVerifier){
          // Missing local context; bounce to start.
          history.replaceState({}, '', '/');
        }else{
          const body = new URLSearchParams({
            client_id: clientId,
            grant_type: 'authorization_code',
            code,
            redirect_uri: REDIRECT_URI,
            code_verifier: codeVerifier
          });
          const resp = await fetch(TOKEN_ENDPOINT, {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body
          });
          const json = await resp.json();
          if (resp.ok){
            storeToken(json);
            // clean URL
            history.replaceState({}, '', '/');
            showDashboard();
            loadAllData();
          }else{
            console.error('Token exchange failed:', json);
            alert('Authorization failed. Check console for details.');
            history.replaceState({}, '', '/');
          }
        }
      }

      attachHandlers();
    });

    function attachHandlers(){
      // Login button â†’ start PKCE flow
      document.getElementById('loginBtn')?.addEventListener('click', async () => {
        const clientId = document.getElementById('clientId').value.trim();
        if (!clientId) { alert('Please enter your Spotify Client ID'); return; }

        // Prepare PKCE
        const verifier = generateRandomString(64);
        const challenge = await pkceChallengeFromVerifier(verifier);
        localStorage.setItem('code_verifier', verifier);
        localStorage.setItem('client_id_for_pkce', clientId);

        const authUrl = new URL(SPOTIFY_AUTH_ENDPOINT);
        authUrl.search = new URLSearchParams({
          response_type: 'code',
          client_id: clientId,
          redirect_uri: REDIRECT_URI,
          scope: SCOPES,
          code_challenge_method: 'S256',
          code_challenge: challenge,
          // Strongly recommended: state
          state: generateRandomString(16)
        }).toString();

        window.location.href = authUrl.toString();
      });

      // Time range buttons
      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentTimeRange = e.target.dataset.range;
          loadAllData();
        });
      });
    }

    // ----- Data loaders (unchanged logic)
    async function loadAllData(){
      loadUserProfile();
      loadTopTracks();
      loadTopArtists();
      loadTopGenres();
      loadAudioFeatures();
      loadRecentlyPlayed();
      loadListeningStats();
      loadRecommendations();
    }

    async function loadUserProfile(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const userData = await fetchSpotifyData('me', clientId);
      if (userData){
        const html = `
          <img src="${userData.images?.[0]?.url || 'https://via.placeholder.com/60'}" class="user-avatar" alt="Profile">
          <div class="user-info">
            <h2>${userData.display_name}</h2>
            <p style="opacity:.8;">${userData.followers.total} followers â€¢ ${userData.product} account</p>
          </div>`;
        const el = document.getElementById('userProfile');
        el.innerHTML = html;
        el.style.display = 'flex';
      }
    }

    async function loadTopTracks(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const data = await fetchSpotifyData(`me/top/tracks?time_range=${currentTimeRange}&limit=10`, clientId);
      if (data?.items){
        const html = `
          <ul class="top-items">
            ${data.items.slice(0,5).map((t,i)=>`
              <li class="top-item">
                <span class="item-rank">${i+1}</span>
                <img src="${t.album.images?.[0]?.url || ''}" alt="${t.name}" class="item-image">
                <div class="item-info">
                  <div class="item-name">${t.name}</div>
                  <div class="item-artist">${t.artists.map(a=>a.name).join(', ')}</div>
                </div>
              </li>`).join('')}
          </ul>`;
        document.getElementById('topTracks').innerHTML = html;
      }
    }

    async function loadTopArtists(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const data = await fetchSpotifyData(`me/top/artists?time_range=${currentTimeRange}&limit=10`, clientId);
      if (data?.items){
        const html = `
          <ul class="top-items">
            ${data.items.slice(0,5).map((a,i)=>`
              <li class="top-item">
                <span class="item-rank">${i+1}</span>
                <img src="${a.images?.[0]?.url || ''}" alt="${a.name}" class="item-image">
                <div class="item-info">
                  <div class="item-name">${a.name}</div>
                  <div class="item-artist">${a.followers.total.toLocaleString()} followers</div>
                </div>
              </li>`).join('')}
          </ul>`;
        document.getElementById('topArtists').innerHTML = html;
      }
    }

    async function loadTopGenres(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const data = await fetchSpotifyData(`me/top/artists?time_range=${currentTimeRange}&limit=50`, clientId);
      if (data?.items){
        const counts = {};
        data.items.forEach(a => a.genres.forEach(g => counts[g]=(counts[g]||0)+1));
        const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const html = `<div class="genre-cloud">
          ${top.map(([g,c])=>`<span class="genre-tag" style="font-size:${0.8+(c/top[0][1])*0.6}em">${g}</span>`).join('')}
        </div>`;
        document.getElementById('topGenres').innerHTML = html;
      }
    }

    async function loadAudioFeatures(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const tracks = await fetchSpotifyData(`me/top/tracks?time_range=${currentTimeRange}&limit=50`, clientId);
      if (tracks?.items?.length){
        const ids = tracks.items.map(t=>t.id).join(',');
        const feats = await fetchSpotifyData(`audio-features?ids=${ids}`, clientId);
        if (feats?.audio_features){
          const avg = {danceability:0,energy:0,valence:0,acousticness:0,instrumentalness:0,speechiness:0};
          feats.audio_features.forEach(f=>{ if(f) for (const k in avg) avg[k]+=f[k]; });
          const n = feats.audio_features.filter(Boolean).length || 1;
          for (const k in avg) avg[k]=avg[k]/n*100;
          const html = `<div class="audio-features">
            ${Object.entries(avg).map(([k,v])=>`
              <div class="feature-item">
                <div class="stat-label">${k[0].toUpperCase()+k.slice(1)}</div>
                <div class="feature-bar"><div class="feature-fill" style="width:${v}%"></div></div>
                <div style="font-size:.9em;opacity:.8;">${Math.round(v)}%</div>
              </div>`).join('')}
          </div>`;
          document.getElementById('audioFeatures').innerHTML = html;
        }
      }
    }

    async function loadRecentlyPlayed(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const data = await fetchSpotifyData('me/player/recently-played?limit=10', clientId);
      if (data?.items){
        const html = `<ul class="top-items">
          ${data.items.slice(0,5).map(item=>`
            <li class="top-item">
              <img src="${item.track.album.images?.[0]?.url || ''}" alt="${item.track.name}" class="item-image">
              <div class="item-info">
                <div class="item-name">${item.track.name}</div>
                <div class="item-artist">${item.track.artists.map(a=>a.name).join(', ')}</div>
              </div>
            </li>`).join('')}
        </ul>`;
        document.getElementById('recentlyPlayed').innerHTML = html;
      }
    }

    async function loadListeningStats(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const [tracks, artists] = await Promise.all([
        fetchSpotifyData(`me/top/tracks?time_range=${currentTimeRange}&limit=50`, clientId),
        fetchSpotifyData(`me/top/artists?time_range=${currentTimeRange}&limit=50`, clientId),
      ]);
      let mins=0;
      if (tracks?.items) tracks.items.forEach(t=>{ mins += t.duration_ms/60000; });

      const text = {short_term:'Last 4 Weeks',medium_term:'Last 6 Months',long_term:'All Time'};
      const html = `
        <div style="text-align:center;">
          <div class="stat-value">${Math.round(mins)}</div>
          <div class="stat-label">Estimated Minutes Listened</div>
          <div style="margin-top:20px;">
            <div class="stat-value" style="font-size:1.8em;">${tracks?.items?.length || 0}</div>
            <div class="stat-label">Unique Top Tracks</div>
          </div>
          <div style="margin-top:20px;">
            <div class="stat-value" style="font-size:1.8em;">${artists?.items?.length || 0}</div>
            <div class="stat-label">Unique Top Artists</div>
          </div>
          <p style="margin-top:20px;opacity:.7;font-size:.9em;">${text[currentTimeRange]}</p>
        </div>`;
      document.getElementById('listeningStats').innerHTML = html;
    }

    async function loadRecommendations(){
      const clientId = localStorage.getItem('client_id_for_pkce');
      const [tracks, artists] = await Promise.all([
        fetchSpotifyData(`me/top/tracks?time_range=${currentTimeRange}&limit=5`, clientId),
        fetchSpotifyData(`me/top/artists?time_range=${currentTimeRange}&limit=5`, clientId),
      ]);
      if (tracks?.items?.length && artists?.items?.length){
        const seedTracks = tracks.items.slice(0,2).map(t=>t.id).join(',');
        const seedArtists = artists.items.slice(0,2).map(a=>a.id).join(',');
        const recs = await fetchSpotifyData(`recommendations?seed_tracks=${seedTracks}&seed_artists=${seedArtists}&limit=12`, clientId);
        if (recs?.tracks){
          const html = recs.tracks.map(t=>`
            <div class="rec-item" onclick="window.open('${t.external_urls.spotify}','_blank')">
              <img src="${t.album.images?.[0]?.url || ''}" alt="${t.name}" class="rec-image">
              <div class="rec-name">${t.name}</div>
              <div class="rec-artist">${t.artists?.[0]?.name || ''}</div>
            </div>`).join('');
          const el = document.getElementById('recommendations');
          el.innerHTML = html;
          el.classList.remove('loading');
        }
      }
    }
  </script>
</body>
</html>
